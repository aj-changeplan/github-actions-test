name: Deployment

on:
  push:
    branches: [main, develop]

jobs:

  Test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: "14.x"

      - name: Setup Meteor.js environment
        uses: meteorengineer/setup-meteor@v1.0.8
      - run: meteor npm i
      - run: meteor npm test

  Deployment:
    runs-on: ubuntu-latest
    needs: Test
    env:
      PRIVATE_KEY: ${{ secrets.KEY  }}
      HOST : ${{ secrets.HOST  }}
      USERNAME : ${{ secrets.USERNAME  }}

    steps:
      - name: Prepare Project Files
        uses: actions/checkout@v2

      - name: Setup Node
        uses: actions/setup-node@v2

      - name: Copy Files via ssh
        uses: garygrossgarten/github-action-scp@v0.8.0
        with:
          local: .
          dotfiles: true
          remote: srv/
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          privateKey: ${{ secrets.KEY }}
      # - run: mkdir ~/home/runner/.ssh
      # - run: echo "$PRIVATE_KEY" > ~/.ssh/private_key && chmod 600 ~/.ssh/private_key
      # - run: ssh -o StrictHostKeyChecking=no -i ~/.ssh/private_key ${USERNAME}@${HOST} "touch sample.txt"

      #   name: Sync files
      # - run: rsync -avz -e "ssh -o StrictHostKeyCHecking=no -o UserKnownHostsFile=/dev/null" --progress . ubuntu@13.229.94.130:/home/ubuntu/srv
